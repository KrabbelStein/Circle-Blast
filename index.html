<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Circle Blast</title>
  <meta name="description" content="Circle Blast — kleines Browsergame. Klicke Kreise an, sammle Punkte und Highscores." />
  <style>
    :root{
      --bg:#0b0b0f; --panel:#111217; --muted:rgba(255,255,255,0.08); --accent:#3b82f6;
      --glass: rgba(255,255,255,0.03);
      --radius:10px;
      --ui-padding:10px;
      --font: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:var(--font);-webkit-font-smoothing:antialiased}
    #game-container{width:100%;height:100vh;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .ui { position:absolute; top:12px; left:12px; z-index:30; display:flex; gap:8px; align-items:center; flex-wrap:wrap; background:transparent; }
    .panel { background:var(--panel); border-radius:var(--radius); padding:var(--ui-padding); display:flex; gap:8px; align-items:center; box-shadow: 0 6px 18px rgba(0,0,0,0.6); }
    .btn { background:linear-gradient(180deg,#1f2937,#111827); color:#fff; border:1px solid rgba(255,255,255,0.04); padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn.ghost { background:transparent; border:1px solid var(--muted); padding:6px 10px; font-weight:600; }
    .score, .highscore { background:var(--glass); padding:8px 12px; border-radius:8px; font-weight:700; }
    .center-msg { position:absolute; z-index:20; color:#ddd; text-align:center; pointer-events:none; left:50%; transform:translateX(-50%); top:36vh; }
    .bottom-right { position:absolute; right:12px; bottom:12px; z-index:20; color:#ddd; font-size:13px; opacity:0.9; }
    .small { font-size:13px; opacity:0.9; }
    @media (max-width:520px){
      .panel{padding:8px}
      .score,.highscore{padding:6px 8px}
      .btn{padding:6px 8px}
    }
  </style>

  <!-- Phaser 3 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
</head>
<body>
  <div id="game-container"></div>

  <div class="ui" aria-hidden="true">
    <div class="panel">
      <div class="score" id="score">Score: 0</div>
      <div class="highscore" id="highscore">Highscore: 0</div>
      <button class="btn" id="startBtn">Start</button>
      <button class="btn ghost" id="resetBtn">Reset</button>
      <button class="btn ghost" id="resetHighBtn" title="Highscore löschen">Reset HS</button>
      <button class="btn ghost" id="soundToggle">Sound On</button>
    </div>
  </div>

  <div class="center-msg" id="centerMsg" role="status" aria-live="polite">
    <h1 style="margin:0 0 8px 0">Circle Blast</h1>
    <div style="opacity:0.85">Klicke Kreise an, um Punkte zu sammeln</div>
  </div>

  <div class="bottom-right small" id="info">Tip: Klick Start</div>

  <script>
    // Konfiguration
    const STORAGE_KEY = 'circle-blast-highscore-v3';
    const MAX_CIRCLES = 6;
    const SPAWN_INTERVAL = 1400; // ms
    const SPAWN_ATTEMPTS = 12;
    const PARTICLE_LIMIT = 10;

    // Phaser Setup
    const config = {
      type: Phaser.AUTO,
      parent: 'game-container',
      width: Math.min(960, window.innerWidth),
      height: Math.min(640, window.innerHeight),
      backgroundColor: '#0b0b0f',
      physics: { default: 'arcade', arcade: { debug: false } },
      scene: { preload, create, update }
    };

    let game = new Phaser.Game(config);
    let score = 0;
    let scoreEl, highEl, centerMsg, infoEl, soundOn = true;
    let running = false;
    // spawnEvent wird in create() gesetzt
    let spawnEvent = null;

    function preload() {
      // Partikel-Texture vorbereiten (wiederverwendbar)
      this.load.once('complete', () => {}, this);
      // optionaler Sound (CDN) - safe try
      try { this.load.audio('pop', 'https://cdn.jsdelivr.net/gh/kripken/sound-effects/pop.mp3'); } catch (e) {}
    }

    function create() {
      const scene = this;
      scoreEl = document.getElementById('score');
      highEl = document.getElementById('highscore');
      centerMsg = document.getElementById('centerMsg');
      infoEl = document.getElementById('info');

      updateHighscoreDisplay(loadHighscore());

      // Gruppe für Kreise
      this.circles = this.add.group();

      // Erzeuge Partikel-Textur einmalig (6x6)
      const g = this.add.graphics();
      g.fillStyle(0xffffff, 1);
      g.fillCircle(3, 3, 3);
      g.generateTexture('particleDot', 6, 6);
      g.destroy();

      // Input: Klick / Touch
      this.input.on('pointerdown', function (pointer) {
        if (!running) return;
        const x = pointer.x;
        const y = pointer.y;
        // coordinate hit test (keine physics collision nötig)
        const hit = scene.circles.getChildren().find(c => {
          const dx = c.x - x;
          const dy = c.y - y;
          return Math.sqrt(dx*dx + dy*dy) <= c.displayWidth/2;
        });
        if (hit) blastCircle(scene, hit);
      });

      // Buttons
      document.getElementById('startBtn').addEventListener('click', () => {
        if (!running) startGame(scene);
      });
      document.getElementById('resetBtn').addEventListener('click', () => {
        resetGame(scene);
      });
      document.getElementById('resetHighBtn').addEventListener('click', () => {
        resetHighscore();
        infoEl.textContent = 'Highscore zurückgesetzt';
        setTimeout(()=> infoEl.textContent = 'Tip: Klick Start', 1600);
      });
      document.getElementById('soundToggle').addEventListener('click', (e) => {
        soundOn = !soundOn;
        e.target.textContent = soundOn ? 'Sound On' : 'Sound Off';
      });

      // Spawn-Event vorbereiten (wird beim Start aktiviert)
      spawnEvent = null;

      // Responsive resize
      window.addEventListener('resize', () => {
        scene.scale.resize(Math.min(960, window.innerWidth), Math.min(640, window.innerHeight));
      });

      // kurze Anleitung
      setTimeout(() => { centerMsg.style.opacity = 0.95; }, 200);
      setTimeout(() => { centerMsg.style.opacity = 0.6; }, 4000);
    }

    function update() {
      // keine spawn-Logik hier mehr
    }

    // Highscore helpers
    function loadHighscore() {
      const v = localStorage.getItem(STORAGE_KEY);
      return v ? parseInt(v, 10) : 0;
    }
    function saveHighscore(value) {
      localStorage.setItem(STORAGE_KEY, String(value));
    }
    function resetHighscore() {
      localStorage.removeItem(STORAGE_KEY);
      updateHighscoreDisplay(0);
    }
    function updateHighscoreDisplay(value) {
      if (highEl) highEl.textContent = 'Highscore: ' + value;
    }

    // Spawn-Funktion (keine physics bodies nötig)
    function spawnCircle(scene) {
      if (!scene || !scene.scale) return;
      if (scene.circles.getLength() >= MAX_CIRCLES) return;

      const size = Phaser.Math.Between(28, 64);
      let chosen = null;

      for (let i=0;i<SPAWN_ATTEMPTS;i++) {
        const half = Math.round(size / 2);
        const x = Phaser.Math.Between(half, scene.scale.width - half);
        const y = Phaser.Math.Between(half + 44, scene.scale.height - half - 60);
        const overlaps = scene.circles.getChildren().some(existing => {
          const dx = existing.x - x;
          const dy = existing.y - y;
          const minDist = (existing.displayWidth + size) * 0.5 + 8;
          return (dx*dx + dy*dy) < (minDist * minDist);
        });
        if (!overlaps) { chosen = {x,y}; break; }
      }

      if (!chosen) return;

      const color = Phaser.Display.Color.RandomRGB();
      const gfx = scene.add.graphics();
      gfx.fillStyle(color.color, 1);
      // draw circle centered in texture
      gfx.fillCircle(Math.round(size/2), Math.round(size/2), Math.round(size/2));
      const textureKey = 'circle' + Phaser.Math.RND.uuid();
      gfx.generateTexture(textureKey, size, size);
      gfx.destroy();

      const sprite = scene.add.image(chosen.x, chosen.y, textureKey);
      sprite.setDisplaySize(size, size);
      sprite.setOrigin(0.5, 0.5);
      // mark custom property to avoid double-handling
      sprite._isBlasting = false;
      scene.circles.add(sprite);

      // auto remove after time (clean remove)
      scene.time.delayedCall(Phaser.Math.Between(6000, 10000), () => {
        if (sprite && sprite.active && !sprite._isBlasting) {
          try { scene.circles.remove(sprite, true, true); } catch (e) { try { sprite.destroy(); } catch(e){} }
        }
      });
    }

    // remove oldest if too many
    function removeOldCircles(scene) {
      while (scene.circles.getLength() > MAX_CIRCLES) {
        const oldest = scene.circles.getChildren()[0];
        if (oldest) {
          try { scene.circles.remove(oldest, true, true); } catch (e) { try { oldest.destroy(); } catch(e){} }
        } else break;
      }
    }

    // blast: disable sprite, tween to center, spawn particles, then destroy
    function blastCircle(scene, sprite) {
      if (!sprite || sprite._isBlasting) return;
      sprite._isBlasting = true;

      // immediately disable interactions and stop any tweens on it
      try {
        sprite.setInteractive(false);
        scene.tweens.killTweensOf(sprite);
      } catch (e) {}

      const size = sprite.displayWidth;
      const pts = Math.max(5, Math.round(80 - size));
      score += pts;
      if (scoreEl) scoreEl.textContent = 'Score: ' + score;

      const currentHigh = loadHighscore();
      if (score > currentHigh) {
        saveHighscore(score);
        updateHighscoreDisplay(score);
        infoEl.textContent = 'Neuer Highscore!';
        setTimeout(()=> infoEl.textContent = 'Tip: Klick Start', 1200);
      }

      const centerX = scene.scale.width / 2;
      const centerY = scene.scale.height / 2;

      // ensure no conflicting tweens
      scene.tweens.killTweensOf(sprite);

      // Tween to center and shrink
      scene.tweens.add({
        targets: sprite,
        x: centerX,
        y: centerY,
        scaleX: 0.05,
        scaleY: 0.05,
        duration: 320,
        ease: 'Cubic.easeIn',
        onComplete: () => {
          // create particle emitter using pre-generated texture
          const particles = scene.add.particles('particleDot');
          const emitter = particles.createEmitter({
            x: centerX, y: centerY,
            speed: { min: 80, max: 220 },
            angle: { min: 0, max: 360 },
            lifespan: 400,
            quantity: Math.min(6, PARTICLE_LIMIT),
            scale: { start: 1.0, end: 0 },
            blendMode: 'ADD'
          });

          // short delay to show particles, then cleanup
          scene.time.delayedCall(300, () => {
            try { emitter.stop(); } catch(e){}
            try { particles.destroy(); } catch(e){}
            try { scene.circles.remove(sprite, true, true); } catch (e) { try { sprite.destroy(); } catch(e){} }
          });
        }
      });

      // safe sound play
      try { if (soundOn && scene.sound && scene.sound.get('pop')) scene.sound.play('pop', { volume: 0.6 }); } catch(e){}
    }

    // startGame: enable spawnEvent and initial circles
    function startGame(scene) {
      // kill existing spawnEvent if any
      try { if (spawnEvent) { spawnEvent.remove(false); spawnEvent = null; } } catch(e){}

      // create repeating spawn event
      spawnEvent = scene.time.addEvent({
        delay: SPAWN_INTERVAL,
        loop: true,
        callback: () => {
          try {
            if (scene.circles.getLength() < MAX_CIRCLES) spawnCircle(scene);
            removeOldCircles(scene);
          } catch(e){}
        }
      });

      // reset score and state
      score = 0;
      if (scoreEl) scoreEl.textContent = 'Score: 0';
      running = true;
      centerMsg.style.display = 'none';
      infoEl.textContent = 'Spiel läuft';

      // spawn a few initial circles
      for (let i=0;i<3;i++) {
        if (scene.circles.getLength() < MAX_CIRCLES) spawnCircle(scene);
      }
    }

    // resetGame: stop spawnEvent, kill tweens, destroy sprites, clear group
    function resetGame(scene) {
      running = false;
      score = 0;
      if (scoreEl) scoreEl.textContent = 'Score: 0';
      centerMsg.style.display = 'block';
      infoEl.textContent = 'Zurückgesetzt';

      // stop spawn event
      try { if (spawnEvent) { spawnEvent.remove(false); spawnEvent = null; } } catch(e){}

      // kill all tweens
      try { scene.tweens.killAll(); } catch(e){}

      // destroy all sprites in group safely
      try {
        const children = scene.circles.getChildren().slice();
        children.forEach(c => {
          try { if (c && c.destroy) c.destroy(); } catch(e){}
        });
        scene.circles.clear(true);
      } catch(e){}

      // small delay for UI message
      setTimeout(()=> infoEl.textContent = 'Tip: Klick Start', 1000);
    }

    // safe helpers for external calls (if needed)
    window.__cb_debug = {
      getActiveCount: () => game.scene.scenes[0].circles ? game.scene.scenes[0].circles.getLength() : 0
    };
  </script>
</body>
</html>
