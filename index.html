<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Circle Blast</title>

<style>
html,body {
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  overflow:hidden;
  background:#0b0b0f;
  color:#fff;
  font-family: system-ui, -apple-system, Segoe UI, Roboto;
}

#game-container {
  width:100%;
  height:100%;
}

.ui {
  position:absolute;
  top:12px;
  left:12px;
  z-index:10;
}

.panel {
  background:#111217;
  padding:10px;
  border-radius:10px;
  display:flex;
  gap:8px;
  align-items:center;
}

.btn {
  background:#1f2937;
  border:none;
  color:white;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}

.score {
  font-weight:700;
}

.timer {
  font-weight:700;
  opacity:0.9;
}

.center-msg {
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  opacity:0.9;
  pointer-events:none;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
</head>
<body>

<div id="game-container"></div>

<div class="ui">
  <div class="panel">
    <div class="score" id="score">Score: 0</div>
    <div class="timer" id="timer">Time: 30</div>
    <button class="btn" id="startBtn">Start</button>
    <button class="btn" id="resetBtn">Reset</button>
  </div>
</div>

<div class="center-msg" id="centerMsg">
  <h1>Circle Blast</h1>
  <p>Kreise anklicken</p>
</div>

<script>
const MAX_CIRCLES = 6;
const SPAWN_DELAY = 1200;
const GAME_TIME = 30;

const config = {
  type: Phaser.AUTO,
  parent: 'game-container',
  width: window.innerWidth,
  height: window.innerHeight,
  backgroundColor: '#0b0b0f',
  scene: { preload, create }
};

new Phaser.Game(config);

function preload() {}

function create() {
  const scene = this;

  const scoreEl = document.getElementById('score');
  const timerEl = document.getElementById('timer');
  const centerMsg = document.getElementById('centerMsg');

  let score = 0;
  let timeLeft = GAME_TIME;
  let running = false;

  let spawnEvent = null;
  let timerEvent = null;

  const circles = scene.add.group();

  // Resize FIX
  window.addEventListener('resize', () => {
    scene.scale.resize(window.innerWidth, window.innerHeight);
  });

  function circleTexture(size, color) {
    const key = `c_${size}_${color}`;
    if (scene.textures.exists(key)) return key;

    const g = scene.add.graphics();
    g.fillStyle(color, 1);
    g.fillCircle(size/2, size/2, size/2);
    g.generateTexture(key, size, size);
    g.destroy();
    return key;
  }

  function spawnCircle() {
    if (!running || circles.getLength() >= MAX_CIRCLES) return;

    const size = Phaser.Math.Between(40, 70);
    const half = size / 2;

    const x = Phaser.Math.Between(half, scene.scale.width - half);
    const y = Phaser.Math.Between(half + 60, scene.scale.height - half);

    const color = Phaser.Display.Color.RandomRGB().color;
    const sprite = scene.add.image(x, y, circleTexture(size, color));

    sprite.setOrigin(0.5);
    sprite.setInteractive({ useHandCursor:true });
    sprite._dead = false;

    sprite.on('pointerdown', () => blast(sprite));
    circles.add(sprite);

    sprite._lifeTimer = scene.time.delayedCall(
      Phaser.Math.Between(5000, 8000),
      () => safeDestroy(sprite)
    );
  }

  function blast(sprite) {
    if (sprite._dead) return;
    sprite._dead = true;

    sprite.disableInteractive();
    sprite._lifeTimer?.remove(false);

    score += 10;
    scoreEl.textContent = 'Score: ' + score;

    const cam = scene.cameras.main;
    const target = cam.midPoint;

    scene.tweens.add({
      targets: sprite,
      x: target.x,
      y: target.y,
      scale: 0,
      duration: 300,
      ease: 'Cubic.easeIn',
      onComplete: () => safeDestroy(sprite)
    });
  }

  function safeDestroy(sprite) {
    if (!sprite || !sprite.active) return;
    sprite.off('pointerdown');
    circles.remove(sprite);
    sprite.destroy();
  }

  function startGame() {
    resetGame();

    running = true;
    timeLeft = GAME_TIME;
    timerEl.textContent = 'Time: ' + timeLeft;
    centerMsg.style.display = 'none';

    spawnEvent = scene.time.addEvent({
      delay: SPAWN_DELAY,
      loop: true,
      callback: spawnCircle
    });

    timerEvent = scene.time.addEvent({
      delay: 1000,
      loop: true,
      callback: () => {
        timeLeft--;
        timerEl.textContent = 'Time: ' + timeLeft;
        if (timeLeft <= 0) endGame();
      }
    });

    for (let i=0;i<3;i++) spawnCircle();
  }

  function endGame() {
    running = false;
    spawnEvent?.remove(false);
    timerEvent?.remove(false);

    centerMsg.style.display = 'flex';
    centerMsg.innerHTML = `<h1>Game Over</h1><p>Score: ${score}</p>`;
  }

  function resetGame() {
    running = false;
    score = 0;
    scoreEl.textContent = 'Score: 0';
    timerEl.textContent = 'Time: ' + GAME_TIME;

    spawnEvent?.remove(false);
    timerEvent?.remove(false);

    circles.getChildren().slice().forEach(s => safeDestroy(s));

    centerMsg.style.display = 'flex';
    centerMsg.innerHTML = `<h1>Circle Blast</h1><p>Kreise anklicken</p>`;
  }

  document.getElementById('startBtn').onclick = () => {
    if (!running) startGame();
  };
  document.getElementById('resetBtn').onclick = resetGame;
}
</script>

</body>
</html>
